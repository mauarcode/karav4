{% extends "admin_base.html" %}

{% block title %}Guiones, Secciones y Datos{% endblock %}

{% block head_extra %}
<style>
    .three-column-layout {
        display: flex;
        height: calc(100vh - 150px);
        height: calc(100dvh - 150px);
        gap: 10px;
        margin-top: 20px;
        flex-direction: row;
    }
    
    .column {
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        overflow-y: auto;
        padding: 15px;
        min-width: 0;
    }
    
    .column.col-small {
        flex: 0 0 20%;
        font-size: 12px;
    }
    
    .column.col-medium {
        flex: 0 0 25%;
        font-size: 12px;
    }
    
    .column.col-large {
        flex: 1;
        font-size: 14px;
    }
    
    /* Responsive para móvil */
    @media (max-width: 768px) {
        .three-column-layout {
            flex-direction: column;
            height: calc(100vh - 120px);
            height: calc(100dvh - 120px);
            gap: 15px;
            margin-top: 15px;
        }
        
        .column.col-small,
        .column.col-medium {
            flex: 0 0 auto;
            max-height: 30vh;
            max-height: 30dvh;
        }
        
        .column.col-large {
            flex: 1;
            min-height: 0;
        }
    }
    
    @media (max-width: 576px) {
        .column {
            padding: 10px;
        }
        
        .column.col-small,
        .column.col-medium {
            max-height: 25vh;
            max-height: 25dvh;
        }
    }
    
    .column-header {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #337ab7;
        color: #337ab7;
    }
    
    .list-item {
        padding: 8px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 12px;
    }
    
    .list-item:hover {
        background-color: #f5f5f5;
    }
    
    .list-item.active {
        background-color: #337ab7;
        color: white;
    }
    
    .list-item.expandable::before {
        content: "▶ ";
        display: inline-block;
        transition: transform 0.2s;
    }
    
    .list-item.expandable.expanded::before {
        transform: rotate(90deg);
    }
    
    .sub-items {
        margin-left: 20px;
        margin-top: 5px;
        display: none;
    }
    
    .sub-items.show {
        display: block;
    }
    
    .sub-item {
        padding: 6px;
        margin-left: 20px;
        margin-bottom: 3px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 11px;
    }
    
    .sub-item:hover {
        background-color: #f0f0f0;
    }
    
    .sub-item.active {
        background-color: #e3f2fd;
        border-color: #2196F3;
    }
    
    .edit-form {
        margin-top: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .form-group textarea {
        min-height: 100px;
    }
    
    .json-editor {
        font-family: monospace;
        min-height: 200px;
    }
    
    .btn-save {
        background-color: #5cb85c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .btn-save:hover {
        background-color: #4cae4c;
    }
    
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    
    .section-info {
        font-size: 10px;
        color: #666;
        margin-top: 3px;
    }
    
    /* Estilos para pestañas */
    .tabs {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 15px;
    }
    
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        font-size: 14px;
        color: #666;
        transition: all 0.2s;
    }
    
    .tab:hover {
        color: #337ab7;
    }
    
    .tab.active {
        color: #337ab7;
        border-bottom-color: #337ab7;
        font-weight: bold;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="page-header">Gestión de Guiones, Secciones y Datos</h1>

<div id="alert-container"></div>

<div class="three-column-layout">
    <!-- Columna 1: Guiones -->
    <div class="column col-small">
        <div class="column-header" style="font-size: 14px;">Guiones</div>
        <div id="guiones-list">
            <div class="empty-state">Cargando guiones...</div>
        </div>
    </div>
    
    <!-- Columna 2: Información de Sección -->
    <div class="column col-medium">
        <div class="column-header" style="font-size: 14px;">Información de Sección</div>
        <div id="secciones-list">
            <div class="empty-state">Selecciona una sección para ver sus datos</div>
        </div>
    </div>
    
    <!-- Columna 3: Editor con Pestañas -->
    <div class="column col-large">
        <div class="column-header" style="font-size: 16px;">Editor</div>
        <div id="editor-container">
            <div class="tabs">
                <button class="tab" id="tab-guion" onclick="switchTab('guion')">Guion</button>
                <button class="tab" id="tab-seccion" onclick="switchTab('seccion')">Sección</button>
                <button class="tab" id="tab-dato" onclick="switchTab('dato')">Dato</button>
            </div>
            
            <!-- Contenido de pestaña Guion -->
            <div id="tab-content-guion" class="tab-content">
                <div class="empty-state">Selecciona un guion para editarlo</div>
            </div>
            
            <!-- Contenido de pestaña Sección -->
            <div id="tab-content-seccion" class="tab-content">
                <div class="empty-state">Selecciona una sección para editarla</div>
            </div>
            
            <!-- Contenido de pestaña Dato -->
            <div id="tab-content-dato" class="tab-content">
                <div class="empty-state">Selecciona un dato para editarlo</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
let currentGuion = null;
let currentSeccion = null;
let currentDato = null;
let currentItemType = null; // 'guion', 'seccion', 'dato'
let currentItemData = null;

// Función para cambiar entre pestañas
function switchTab(tabName) {
    // Ocultar todas las pestañas
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar la pestaña seleccionada
    const tabButton = document.getElementById(`tab-${tabName}`);
    const tabContent = document.getElementById(`tab-content-${tabName}`);
    
    if (tabButton && tabContent) {
        tabButton.classList.add('active');
        tabContent.classList.add('active');
        
        // Cargar el contenido según el tipo solo si hay datos disponibles
        if (tabName === 'guion' && currentGuion) {
            loadGuionEditor(currentGuion);
        } else if (tabName === 'seccion' && currentSeccion && currentSeccion.data) {
            loadSeccionEditor(currentSeccion);
        } else if (tabName === 'dato' && currentItemData && currentItemData.dato) {
            loadDatoEditor(currentItemData.dato, currentItemData.clave, currentItemData.tipo);
        }
    }
}

// Cargar guiones al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadGuiones();
    // Inicializar primera pestaña como activa
    switchTab('guion');
});

async function loadGuiones() {
    try {
        const response = await fetch(apiUrl('admin/api/guiones'));
        const data = await response.json();
        
        const guionesList = document.getElementById('guiones-list');
        if (data.guiones && data.guiones.length > 0) {
            guionesList.innerHTML = '';
            data.guiones.forEach(guion => {
                // Crear contenedor para el guion
                const guionContainer = document.createElement('div');
                guionContainer.className = 'guion-container';
                
                // Crear el item del guion
                const item = document.createElement('div');
                item.className = 'list-item expandable';
                item.textContent = guion.nombre;
                item.dataset.guionId = guion.id;
                item.dataset.guionData = JSON.stringify(guion);
                item.onclick = (e) => {
                    e.stopPropagation();
                    toggleGuion(guion, item, guionContainer);
                };
                
                // Crear contenedor para las secciones (inicialmente oculto)
                const seccionesContainer = document.createElement('div');
                seccionesContainer.className = 'sub-items';
                seccionesContainer.dataset.guionId = guion.id;
                
                guionContainer.appendChild(item);
                guionContainer.appendChild(seccionesContainer);
                guionesList.appendChild(guionContainer);
            });
        } else {
            guionesList.innerHTML = '<div class="empty-state">No hay guiones disponibles</div>';
        }
    } catch (error) {
        showAlert('Error cargando guiones: ' + error.message, 'error');
    }
}

function toggleGuion(guion, element, container) {
    // Toggle expanded state
    element.classList.toggle('expanded');
    
    // Encontrar el contenedor de secciones
    const seccionesContainer = container.querySelector('.sub-items');
    
    if (element.classList.contains('expanded')) {
        // Expandir: mostrar secciones debajo del guion
        seccionesContainer.classList.add('show');
        currentGuion = guion;
        loadSecciones(guion, seccionesContainer);
        
        // Cargar editor de guion en la pestaña correspondiente
        loadGuionEditor(guion);
        switchTab('guion');
    } else {
        // Colapsar: ocultar secciones
        seccionesContainer.classList.remove('show');
        seccionesContainer.innerHTML = '';
        currentGuion = null;
        
        // Limpiar las otras columnas
        document.getElementById('secciones-list').innerHTML = '<div class="empty-state">Selecciona una sección</div>';
        clearAllTabs();
    }
}

async function loadSecciones(guion, seccionesContainer) {
    try {
        seccionesContainer.innerHTML = '';
        
        if (!guion.secciones || guion.secciones.length === 0) {
            seccionesContainer.innerHTML = '<div class="empty-state" style="margin-left: 20px; padding: 10px;">Este guion no tiene secciones</div>';
            return;
        }
        
        // Agrupar secciones por archivo
        const seccionesMap = {};
        guion.secciones.forEach(seccion => {
            const archivo = seccion.archivo;
            if (!seccionesMap[archivo]) {
                seccionesMap[archivo] = [];
            }
            seccionesMap[archivo].push(seccion);
        });
        
        // Mostrar secciones como sub-items debajo del guion
        for (const [archivo, secciones] of Object.entries(seccionesMap)) {
            const item = document.createElement('div');
            item.className = 'sub-item';
            item.innerHTML = `
                <div><strong>${archivo}</strong></div>
                <div class="section-info" style="font-size: 11px; color: #666;">Tipo: ${secciones[0].tipo || 'N/A'} | ${secciones.length} sección(es)</div>
            `;
            item.dataset.archivo = archivo;
            item.onclick = (e) => {
                e.stopPropagation();
                // Remover active de otros items
                seccionesContainer.querySelectorAll('.sub-item').forEach(subItem => {
                    subItem.classList.remove('active');
                });
                item.classList.add('active');
                selectSeccion(archivo, secciones);
            };
            seccionesContainer.appendChild(item);
        }
    } catch (error) {
        showAlert('Error cargando secciones: ' + error.message, 'error');
    }
}

function selectSeccion(archivo, seccionesGuion) {
    // Cargar los datos de la sección y mostrarlos en la segunda columna
    currentSeccion = { archivo, seccionesGuion };
    loadSeccionData(archivo);
    
    // Cargar editor de sección en la pestaña correspondiente
    switchTab('seccion');
}

// Esta función ya no se usa, pero la mantenemos por si acaso
async function toggleSeccion(archivo, seccionesGuion, element) {
    selectSeccion(archivo, seccionesGuion);
}

async function loadSeccionData(archivo) {
    try {
        const response = await fetch(apiUrl(`admin/api/secciones/${archivo}`));
        
        if (!response.ok) {
            // Intentar obtener el mensaje de error del servidor
            let errorMessage = `HTTP error! status: ${response.status}`;
            try {
                const errorData = await response.json();
                if (errorData.detail) {
                    errorMessage = errorData.detail;
                }
            } catch (e) {
                // Si no se puede parsear el JSON, usar el mensaje por defecto
            }
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        // Validar que data y data.seccion existan
        if (!data || !data.seccion) {
            throw new Error('La respuesta de la API no contiene datos de sección válidos');
        }
        
        currentSeccion.data = data.seccion;
        
        // Mostrar los datos en la SEGUNDA columna (secciones-list)
        const seccionesList = document.getElementById('secciones-list');
        seccionesList.innerHTML = '';
        
        // La sección tiene una estructura con una clave principal
        // Validar que data.seccion sea un objeto y tenga al menos una clave
        if (typeof data.seccion !== 'object' || data.seccion === null) {
            throw new Error('La sección no tiene un formato válido');
        }
        
        const seccionKeys = Object.keys(data.seccion);
        if (seccionKeys.length === 0) {
            seccionesList.innerHTML = '<div class="empty-state">Esta sección está vacía</div>';
            return;
        }
        
        const seccionKey = seccionKeys[0];
        const seccionContent = data.seccion[seccionKey];
        
        // Mostrar información de la sección
        const sectionHeader = document.createElement('div');
        sectionHeader.className = 'list-item';
        sectionHeader.style.backgroundColor = '#e3f2fd';
        sectionHeader.style.marginBottom = '15px';
        sectionHeader.innerHTML = `
            <div><strong>${archivo}</strong></div>
            <div class="section-info">Tipo: ${currentSeccion.seccionesGuion[0].tipo || 'N/A'}</div>
            <div class="section-info" style="margin-top: 5px;">
                Idiomas: ${seccionContent.idiomas_disponibles ? seccionContent.idiomas_disponibles.join(', ') : 'N/A'}
            </div>
        `;
        seccionesList.appendChild(sectionHeader);
        
        // Validar que seccionContent exista y tenga grupo_datos
        if (!seccionContent) {
            seccionesList.innerHTML += '<div class="empty-state">Esta sección no tiene contenido</div>';
            return;
        }
        
        // Mostrar los datos de la sección
        if (seccionContent.grupo_datos && Array.isArray(seccionContent.grupo_datos) && seccionContent.grupo_datos.length > 0) {
            const datosTitle = document.createElement('div');
            datosTitle.style.fontWeight = 'bold';
            datosTitle.style.marginTop = '15px';
            datosTitle.style.marginBottom = '10px';
            datosTitle.textContent = 'Datos de la sección:';
            seccionesList.appendChild(datosTitle);
            
            seccionContent.grupo_datos.forEach(datoRef => {
                if (!datoRef || !datoRef.clave) {
                    console.warn('Dato de referencia inválido:', datoRef);
                    return;
                }
                
                const item = document.createElement('div');
                item.className = 'list-item';
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div><strong>${datoRef.clave}</strong></div>
                    <div class="section-info">${datoRef.nombre || 'Sin nombre'} (ID: ${datoRef.id || 'N/A'})</div>
                `;
                item.onclick = () => loadDato(datoRef, seccionContent);
                seccionesList.appendChild(item);
            });
        } else {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'empty-state';
            emptyMsg.textContent = 'Esta sección no tiene datos asociados';
            seccionesList.appendChild(emptyMsg);
        }
        
        // Agregar botón para editar la sección
        const editSectionBtn = document.createElement('button');
        editSectionBtn.className = 'btn btn-primary';
        editSectionBtn.textContent = 'Editar Sección';
        editSectionBtn.style.marginTop = '15px';
        editSectionBtn.style.width = '100%';
        editSectionBtn.onclick = () => editSeccion(data.seccion, archivo);
        seccionesList.appendChild(editSectionBtn);
        
        // Cargar editor de sección
        loadSeccionEditor(currentSeccion);
        
    } catch (error) {
        console.error('Error detallado al cargar sección:', error);
        
        let errorMessage = 'Error cargando datos de la sección: ' + error.message;
        
        // Si es un error 404, mostrar mensaje más específico
        if (error.message.includes('404') || error.message.includes('no encontrada')) {
            errorMessage = `El archivo de sección "${archivo}" no existe. `;
            errorMessage += 'Verifica que el nombre del archivo en el guion coincida con un archivo en la carpeta de secciones.';
        }
        
        showAlert(errorMessage, 'error');
        const seccionesList = document.getElementById('secciones-list');
        seccionesList.innerHTML = `
            <div class="empty-state">
                <p><strong>Error al cargar la sección</strong></p>
                <p>Archivo: ${archivo}</p>
                <p style="font-size: 12px; color: #666;">${error.message}</p>
            </div>
        `;
    }
}

async function loadDato(datoRef, seccionContent) {
    // Determinar el tipo de dato basado en la naturaleza de la sección
    let tipoDato = 'dato_plano';
    
    if (currentSeccion && currentSeccion.seccionesGuion && currentSeccion.seccionesGuion.length > 0) {
        const primeraSeccion = currentSeccion.seccionesGuion[0];
        if (primeraSeccion.tipo === 'texto_informativo') {
            tipoDato = 'informativo';
        } else if (primeraSeccion.tipo === 'entrevista') {
            if (primeraSeccion.naturaleza === 'grupo') {
                tipoDato = 'grupo';
            } else if (primeraSeccion.naturaleza === 'dato_plano') {
                tipoDato = 'dato_plano';
            }
        }
    }
    
    // Detectar tipo por patrón de clave
    // Si la clave empieza con "IN_", es informativo
    if (datoRef.clave.startsWith('IN_')) {
        tipoDato = 'informativo';
    }
    // Si la clave empieza con "G" y tiene formato G001_01, es grupo
    else if (datoRef.clave.match(/^G\d{3}_\d{2}$/)) {
        tipoDato = 'grupo';
    }
    // Si la clave empieza con "AR_", es archivo
    else if (datoRef.clave.startsWith('AR_')) {
        tipoDato = 'archivo';
    }
    // Si la clave tiene formato como "01_MIRL", "02_MIRC", etc., es conductual
    else if (datoRef.clave.match(/^\d{2}_[A-Z]+$/)) {
        tipoDato = 'conductual';
    }
    // Si la clave es solo números (001, 002, etc.), es dato_plano
    else if (datoRef.clave.match(/^\d+$/)) {
        tipoDato = 'dato_plano';
    }
    
    try {
        const response = await fetch(apiUrl(`admin/api/datos/${tipoDato}/${datoRef.clave}`));
        const data = await response.json();
        
        currentDato = data.dato;
        currentItemType = 'dato';
        currentItemData = {
            tipo: tipoDato,
            clave: datoRef.clave,
            dato: data.dato
        };
        
        // Cargar editor de dato en la pestaña correspondiente
        loadDatoEditor(data.dato, datoRef.clave, tipoDato);
        switchTab('dato');
    } catch (error) {
        showAlert('Error cargando dato: ' + error.message, 'error');
    }
}

function editSeccion(seccionData, archivo) {
    currentItemType = 'seccion';
    currentItemData = {
        archivo: archivo,
        seccion: seccionData
    };
    currentSeccion = { archivo, data: seccionData };
    loadSeccionEditor(currentSeccion);
    switchTab('seccion');
}

// Función para limpiar todas las pestañas
function clearAllTabs() {
    document.getElementById('tab-content-guion').innerHTML = '<div class="empty-state">Selecciona un guion para editarlo</div>';
    document.getElementById('tab-content-seccion').innerHTML = '<div class="empty-state">Selecciona una sección para editarla</div>';
    document.getElementById('tab-content-dato').innerHTML = '<div class="empty-state">Selecciona un dato para editarlo</div>';
}

// Función para cargar el editor de guion
function loadGuionEditor(guion) {
    const content = document.getElementById('tab-content-guion');
    content.innerHTML = '';
    
    // Crear una copia para editar
    const guionDataCopy = JSON.parse(JSON.stringify(guion.secciones));
    
    const form = createFormFromObject(guionDataCopy, 'guion');
    content.appendChild(form);
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.textContent = 'Guardar Guion';
    saveBtn.onclick = () => {
        // Usar currentItemData que se actualiza con los cambios
        saveGuion(guion.id, currentItemData ? currentItemData.guion : guionDataCopy);
    };
    content.appendChild(saveBtn);
    
    currentItemType = 'guion';
    currentItemData = { id: guion.id, guion: guionDataCopy };
}

// Función para cargar el editor de sección
function loadSeccionEditor(seccion) {
    const content = document.getElementById('tab-content-seccion');
    content.innerHTML = '';
    
    if (!seccion.data) {
        content.innerHTML = '<div class="empty-state">Cargando datos de la sección...</div>';
        return;
    }
    
    // Crear una copia para editar
    const seccionDataCopy = JSON.parse(JSON.stringify(seccion.data));
    
    const form = createFormFromObject(seccionDataCopy, 'seccion');
    content.appendChild(form);
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.textContent = 'Guardar Sección';
    saveBtn.onclick = () => {
        // Usar currentItemData que se actualiza con los cambios
        saveSeccion(seccion.archivo, currentItemData ? currentItemData.seccion : seccionDataCopy);
    };
    content.appendChild(saveBtn);
    
    currentItemType = 'seccion';
    currentItemData = { archivo: seccion.archivo, seccion: seccionDataCopy };
}

// Función para cargar el editor de dato
function loadDatoEditor(dato, clave, tipo) {
    const content = document.getElementById('tab-content-dato');
    content.innerHTML = '';
    
    // Crear una copia para editar
    const datoCopy = JSON.parse(JSON.stringify(dato));
    
    const form = createFormFromObject(datoCopy, 'dato');
    content.appendChild(form);
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.textContent = 'Guardar Dato';
    saveBtn.onclick = () => {
        // Usar currentItemData que se actualiza con los cambios
        saveDato(tipo, clave, currentItemData ? currentItemData.dato : datoCopy);
    };
    content.appendChild(saveBtn);
    
    currentItemType = 'dato';
    currentItemData = { tipo: tipo, clave: clave, dato: datoCopy };
}

function createFormFromObject(obj, type) {
    const container = document.createElement('div');
    
    function createField(key, value, path = '') {
        const fieldPath = path ? `${path}.${key}` : key;
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'form-group';
        
        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            // Es un objeto, crear un collapsible
            const label = document.createElement('label');
            label.textContent = key;
            label.style.cursor = 'pointer';
            label.onclick = () => {
                const content = fieldDiv.querySelector('.nested-content');
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            };
            
            const nestedContent = document.createElement('div');
            nestedContent.className = 'nested-content';
            nestedContent.style.marginLeft = '20px';
            nestedContent.style.borderLeft = '2px solid #ddd';
            nestedContent.style.paddingLeft = '10px';
            
            Object.keys(value).forEach(subKey => {
                nestedContent.appendChild(createField(subKey, value[subKey], fieldPath));
            });
            
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(nestedContent);
        } else if (Array.isArray(value)) {
            // Es un array
            const label = document.createElement('label');
            label.textContent = key + ' (Array)';
            const textarea = document.createElement('textarea');
            textarea.className = 'json-editor';
            textarea.value = JSON.stringify(value, null, 2);
            textarea.dataset.path = fieldPath;
            textarea.onchange = () => {
                try {
                    const parsed = JSON.parse(textarea.value);
                    // Actualizar según el tipo
                    if (type === 'dato' && currentItemData) {
                        setNestedValue(currentItemData.dato, fieldPath, parsed);
                    } else if (type === 'seccion' && currentItemData) {
                        setNestedValue(currentItemData.seccion, fieldPath, parsed);
                    } else if (type === 'guion' && currentItemData) {
                        setNestedValue(currentItemData.guion, fieldPath, parsed);
                    }
                } catch (e) {
                    showAlert('JSON inválido: ' + e.message, 'error');
                }
            };
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(textarea);
        } else {
            // Valor simple
            const label = document.createElement('label');
            label.textContent = key;
            const input = document.createElement('input');
            input.type = typeof value === 'number' ? 'number' : 'text';
            input.value = value === null ? '' : value;
            input.dataset.path = fieldPath;
            input.onchange = () => {
                const newValue = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                // Actualizar según el tipo
                if (type === 'dato' && currentItemData) {
                    setNestedValue(currentItemData.dato, fieldPath, newValue);
                } else if (type === 'seccion' && currentItemData) {
                    setNestedValue(currentItemData.seccion, fieldPath, newValue);
                } else if (type === 'guion' && currentItemData) {
                    setNestedValue(currentItemData.guion, fieldPath, newValue);
                }
            };
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);
        }
        
        return fieldDiv;
    }
    
    Object.keys(obj).forEach(key => {
        container.appendChild(createField(key, obj[key]));
    });
    
    return container;
}

function setNestedValue(obj, path, value) {
    const keys = path.split('.');
    let current = obj;
    for (let i = 0; i < keys.length - 1; i++) {
        if (!(keys[i] in current)) {
            current[keys[i]] = {};
        }
        current = current[keys[i]];
    }
    current[keys[keys.length - 1]] = value;
}

async function saveGuion(guionId, guionData) {
    try {
        const response = await fetch(apiUrl(`admin/api/guiones/${guionId}`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ guion: guionData })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert('Error: ' + (result.message || 'Error desconocido'), 'error');
        }
    } catch (error) {
        showAlert('Error guardando guion: ' + error.message, 'error');
    }
}

async function saveSeccion(archivo, seccionData) {
    try {
        const response = await fetch(apiUrl(`admin/api/secciones/${archivo}`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ seccion: seccionData })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            // Actualizar los datos en currentSeccion
            if (currentSeccion) {
                currentSeccion.data = seccionData;
            }
        } else {
            showAlert('Error: ' + (result.message || 'Error desconocido'), 'error');
        }
    } catch (error) {
        showAlert('Error guardando sección: ' + error.message, 'error');
    }
}

async function saveDato(tipo, clave, datoData) {
    try {
        const response = await fetch(apiUrl(`admin/api/datos/${tipo}/${clave}`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dato: datoData })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            // Actualizar los datos en currentDato
            currentDato = datoData;
        } else {
            showAlert('Error: ' + (result.message || 'Error desconocido'), 'error');
        }
    } catch (error) {
        showAlert('Error guardando dato: ' + error.message, 'error');
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}

