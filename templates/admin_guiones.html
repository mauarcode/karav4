{% extends "admin_base.html" %}

{% block title %}Gestión de Guiones{% endblock %}

{% block head_extra %}
<style>
    .two-column-layout {
        display: flex;
        height: calc(100vh - 150px);
        height: calc(100dvh - 150px);
        gap: 20px;
        margin-top: 20px;
        flex-direction: row;
    }
    
    .column {
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        overflow-y: auto;
        padding: 15px;
    }
    
    .column-left {
        flex: 0 0 35%;
        min-width: 0;
    }
    
    .column-right {
        flex: 1;
        min-width: 0;
    }
    
    /* Responsive para móvil */
    @media (max-width: 768px) {
        .two-column-layout {
            flex-direction: column;
            height: calc(100vh - 120px);
            height: calc(100dvh - 120px);
            gap: 15px;
            margin-top: 15px;
        }
        
        .column-left {
            flex: 0 0 auto;
            max-height: 40vh;
            max-height: 40dvh;
        }
        
        .column-right {
            flex: 1;
            min-height: 0;
        }
    }
    
    @media (max-width: 576px) {
        .column-left {
            max-height: 35vh;
            max-height: 35dvh;
            padding: 10px;
        }
        
        .column-right {
            padding: 10px;
        }
    }
    
    .column-header {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #337ab7;
        color: #337ab7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn-new {
        background-color: #5cb85c;
        color: white;
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-new:hover {
        background-color: #4cae4c;
    }
    
    .btn-save {
        background-color: #337ab7;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 15px;
        width: 100%;
    }
    
    .btn-save:hover {
        background-color: #286090;
    }
    
    .btn-delete {
        background-color: #d9534f;
        color: white;
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
    }
    
    .btn-delete:hover {
        background-color: #c9302c;
    }
    
    .guion-item {
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .guion-item:hover {
        background-color: #f5f5f5;
    }
    
    .guion-item.active {
        background-color: #337ab7;
        color: white;
    }
    
    .guion-item.active:hover {
        background-color: #286090;
    }
    
    .guion-name {
        font-weight: bold;
    }
    
    .guion-empresa {
        font-size: 11px;
        color: #666;
        margin-top: 3px;
    }
    
    .guion-item.active .guion-empresa {
        color: #e0e0e0;
    }
    
    .seccion-item {
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fafafa;
    }
    
    .seccion-header {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }
    
    .seccion-checkbox {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .seccion-name {
        flex: 1;
        font-weight: bold;
    }
    
    .seccion-info {
        font-size: 11px;
        color: #666;
        margin-left: 28px;
        margin-top: 3px;
    }
    
    .seccion-toggle {
        margin-left: 10px;
        cursor: pointer;
        color: #337ab7;
        font-size: 12px;
    }
    
    .seccion-datos {
        margin-left: 28px;
        margin-top: 10px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        display: none;
    }
    
    .seccion-datos.expanded {
        display: block;
    }
    
    .dato-item {
        padding: 5px;
        margin-bottom: 3px;
        font-size: 11px;
        color: #555;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    
    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="page-header">Gestión de Guiones</h1>

<div id="alert-container"></div>

<div class="two-column-layout">
    <!-- Columna Izquierda: Guiones -->
    <div class="column column-left">
        <div class="column-header">
            <span>Guiones</span>
            <button class="btn-new" onclick="createNewGuion()">+ Nuevo Guion</button>
        </div>
        <div id="guiones-list">
            <div class="empty-state">Cargando guiones...</div>
        </div>
    </div>
    
    <!-- Columna Derecha: Secciones -->
    <div class="column column-right">
        <div class="column-header">
            <span>Secciones Disponibles</span>
        </div>
        <div id="secciones-list">
            <div class="empty-state">Selecciona un guion para ver sus secciones</div>
        </div>
    </div>
</div>

<!-- Modal para crear nuevo guion -->
<div id="new-guion-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; border-radius: 4px; width: 400px; max-width: 90%;">
        <h3>Crear Nuevo Guion</h3>
        <div class="form-group">
            <label>ID del Guion:</label>
            <input type="text" id="new-guion-id" placeholder="Ej: G01_LABORAL_STD" />
        </div>
        <div class="form-group">
            <label>Empresa:</label>
            <select id="new-guion-empresa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Selecciona una empresa</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-save" onclick="confirmCreateGuion()" style="margin: 0; flex: 1;">Crear</button>
            <button class="btn-delete" onclick="cancelCreateGuion()" style="margin: 0; flex: 1; background: #999;">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
let allGuiones = [];
let allSecciones = [];
let currentGuion = null;
let currentGuionSecciones = [];

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadGuiones();
    loadSeccionesDisponibles();
    loadEmpresas();
});

async function loadGuiones() {
    try {
        const response = await fetch(apiUrl('admin/api/guiones'));
        const data = await response.json();
        allGuiones = data.guiones || [];
        renderGuiones();
    } catch (error) {
        showAlert('Error cargando guiones: ' + error.message, 'error');
    }
}

async function loadSeccionesDisponibles() {
    try {
        const response = await fetch(apiUrl('admin/api/secciones-disponibles'));
        const data = await response.json();
        allSecciones = data.secciones || [];
    } catch (error) {
        showAlert('Error cargando secciones: ' + error.message, 'error');
    }
}

async function loadEmpresas() {
    try {
        const response = await fetch(apiUrl('admin/api/empresas'));
        const data = await response.json();
        const empresasSelect = document.getElementById('new-guion-empresa');
        if (empresasSelect && data.empresas) {
            data.empresas.forEach(empresa => {
                const option = document.createElement('option');
                option.value = empresa;
                option.textContent = empresa;
                empresasSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando empresas:', error);
    }
}

function renderGuiones() {
    const guionesList = document.getElementById('guiones-list');
    if (allGuiones.length === 0) {
        guionesList.innerHTML = '<div class="empty-state">No hay guiones disponibles</div>';
        return;
    }
    
    guionesList.innerHTML = '';
    allGuiones.forEach(guion => {
        const item = document.createElement('div');
        item.className = 'guion-item';
        if (currentGuion && currentGuion.id === guion.id) {
            item.classList.add('active');
        }
        item.innerHTML = `
            <div>
                <div class="guion-name">${guion.nombre}</div>
                ${guion.empresa ? `<div class="guion-empresa">${guion.empresa}</div>` : ''}
            </div>
            <button class="btn-delete" onclick="deleteGuion('${guion.id}', event)">Eliminar</button>
        `;
        item.onclick = (e) => {
            if (e.target.classList.contains('btn-delete')) return;
            selectGuion(guion);
        };
        guionesList.appendChild(item);
    });
}

function selectGuion(guion) {
    currentGuion = guion;
    currentGuionSecciones = guion.secciones || [];
    renderGuiones();
    renderSecciones();
}

function renderSecciones() {
    const seccionesList = document.getElementById('secciones-list');
    
    if (!currentGuion) {
        seccionesList.innerHTML = '<div class="empty-state">Selecciona un guion para ver sus secciones</div>';
        return;
    }
    
    // Crear un mapa de secciones activas en el guion actual
    const activeSecciones = new Set();
    currentGuionSecciones.forEach(seccion => {
        const archivo = seccion.archivo || seccion.archivo_completo;
        if (archivo) {
            // Remover extensión .json si existe
            activeSecciones.add(archivo.replace('.json', ''));
        }
    });
    
    seccionesList.innerHTML = '';
    
    if (allSecciones.length === 0) {
        seccionesList.innerHTML = '<div class="empty-state">No hay secciones disponibles</div>';
        return;
    }
    
    allSecciones.forEach(seccion => {
        const seccionItem = document.createElement('div');
        seccionItem.className = 'seccion-item';
        const isChecked = activeSecciones.has(seccion.archivo);
        
        seccionItem.innerHTML = `
            <div class="seccion-header">
                <input type="checkbox" class="seccion-checkbox" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleSeccion('${seccion.archivo}', this.checked)"
                       data-archivo="${seccion.archivo}">
                <span class="seccion-name">${seccion.archivo}</span>
                ${seccion.datos_count > 0 ? `<span class="seccion-toggle" onclick="toggleDatos(event, '${seccion.archivo}')">▼ Ver datos (${seccion.datos_count})</span>` : ''}
            </div>
            <div class="seccion-info">
                Tipo: ${seccion.tipo || 'N/A'} | 
                ${seccion.empresa ? `Empresa: ${seccion.empresa}` : 'Sin empresa'}
            </div>
            <div class="seccion-datos" id="datos-${seccion.archivo}">
                ${renderDatosList(seccion.grupo_datos || [])}
            </div>
        `;
        seccionesList.appendChild(seccionItem);
    });
    
    // Botón para guardar cambios
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.textContent = 'Guardar Cambios';
    saveBtn.onclick = saveGuion;
    seccionesList.appendChild(saveBtn);
}

function renderDatosList(grupoDatos) {
    if (!grupoDatos || grupoDatos.length === 0) {
        return '<div class="dato-item">No hay datos asociados</div>';
    }
    
    return grupoDatos.map(dato => {
        const clave = dato.clave || dato.id || 'N/A';
        const nombre = dato.nombre || 'Sin nombre';
        return `<div class="dato-item">• ${clave}: ${nombre}</div>`;
    }).join('');
}

function toggleSeccion(archivo, isChecked) {
    if (!currentGuion) return;
    
    // Actualizar la lista de secciones del guion
    if (isChecked) {
        // Agregar sección si no existe
        const exists = currentGuionSecciones.some(s => {
            const sArchivo = s.archivo || s.archivo_completo;
            return sArchivo && sArchivo.replace('.json', '') === archivo;
        });
        
        if (!exists) {
            // Buscar la sección completa en allSecciones
            const seccionCompleta = allSecciones.find(s => s.archivo === archivo);
            if (seccionCompleta) {
                // Determinar el tipo
                let tipo = seccionCompleta.tipo || 'entrevista';
                if (archivo.toUpperCase().includes('INFORMATIVO')) {
                    tipo = 'texto_informativo';
                }
                
                // Crear entrada de sección
                const nuevaSeccion = {
                    id: currentGuionSecciones.length + 1,
                    tipo: tipo,
                    archivo: archivo
                };
                
                // Si es entrevista, intentar determinar la naturaleza
                if (tipo === 'entrevista' && seccionCompleta.grupo_datos) {
                    const tieneGrupos = seccionCompleta.grupo_datos.some(d => 
                        d.clave && d.clave.startsWith('G')
                    );
                    const tieneArchivos = seccionCompleta.grupo_datos.some(d => 
                        d.clave && d.clave.startsWith('AR_')
                    );
                    
                    if (tieneGrupos) {
                        nuevaSeccion.naturaleza = 'grupo';
                    } else if (tieneArchivos) {
                        nuevaSeccion.naturaleza = 'archivo';
                    } else {
                        nuevaSeccion.naturaleza = 'dato_plano';
                    }
                }
                
                currentGuionSecciones.push(nuevaSeccion);
            }
        }
    } else {
        // Remover sección
        currentGuionSecciones = currentGuionSecciones.filter(s => {
            const sArchivo = s.archivo || s.archivo_completo;
            return sArchivo && sArchivo.replace('.json', '') !== archivo;
        });
    }
}

function toggleDatos(event, archivo) {
    event.stopPropagation();
    const datosDiv = document.getElementById(`datos-${archivo}`);
    const toggle = event.target;
    
    if (datosDiv.classList.contains('expanded')) {
        datosDiv.classList.remove('expanded');
        toggle.textContent = `▼ Ver datos (${allSecciones.find(s => s.archivo === archivo)?.datos_count || 0})`;
    } else {
        datosDiv.classList.add('expanded');
        toggle.textContent = '▲ Ocultar datos';
    }
}

function createNewGuion() {
    document.getElementById('new-guion-modal').style.display = 'flex';
    document.getElementById('new-guion-id').value = '';
    document.getElementById('new-guion-empresa').value = '';
}

function cancelCreateGuion() {
    document.getElementById('new-guion-modal').style.display = 'none';
}

async function confirmCreateGuion() {
    const guionId = document.getElementById('new-guion-id').value.trim();
    const empresa = document.getElementById('new-guion-empresa').value;
    
    if (!guionId) {
        showAlert('Por favor ingresa un ID para el guion', 'error');
        return;
    }
    
    if (!empresa) {
        showAlert('Por favor selecciona una empresa', 'error');
        return;
    }
    
    // Verificar que el guion no exista ya
    const exists = allGuiones.some(g => g.id === guionId && g.empresa === empresa);
    if (exists) {
        showAlert('Ya existe un guion con ese ID en esa empresa', 'error');
        return;
    }
    
    // Crear nuevo guion vacío
    const nuevoGuion = {
        id: guionId,
        nombre: `${empresa} - ${guionId}`,
        empresa: empresa,
        archivo: `${guionId}.json`,
        secciones: []
    };
    
    // Guardar el archivo
    try {
        const response = await fetch(apiUrl(`admin/api/guiones/${guionId}`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                guion: [],
                empresa: empresa
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            allGuiones.push(nuevoGuion);
            renderGuiones();
            selectGuion(nuevoGuion);
            cancelCreateGuion();
            showAlert('Guion creado exitosamente', 'success');
        } else {
            const errorMsg = result.detail || result.message || 'Error desconocido';
            showAlert('Error creando guion: ' + errorMsg, 'error');
        }
    } catch (error) {
        showAlert('Error creando guion: ' + error.message, 'error');
    }
}

async function saveGuion() {
    if (!currentGuion) {
        showAlert('No hay guion seleccionado', 'error');
        return;
    }
    
    try {
        const response = await fetch(apiUrl(`admin/api/guiones/${currentGuion.id}`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ guion: currentGuionSecciones })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            // Actualizar el guion en la lista
            const guionIndex = allGuiones.findIndex(g => g.id === currentGuion.id);
            if (guionIndex !== -1) {
                allGuiones[guionIndex].secciones = currentGuionSecciones;
            }
        } else {
            showAlert('Error: ' + (result.message || 'Error desconocido'), 'error');
        }
    } catch (error) {
        showAlert('Error guardando guion: ' + error.message, 'error');
    }
}

async function deleteGuion(guionId, event) {
    event.stopPropagation();
    
    if (!confirm('¿Estás seguro de que deseas eliminar este guion?')) {
        return;
    }
    
    try {
        // Buscar el archivo del guion
        const guion = allGuiones.find(g => g.id === guionId);
        if (!guion) {
            showAlert('Guion no encontrado', 'error');
            return;
        }
        
        // Eliminar el archivo
        const response = await fetch(apiUrl(`admin/api/guiones/${guionId}`), {
            method: 'DELETE'
        });
        
        if (response.ok) {
            allGuiones = allGuiones.filter(g => g.id !== guionId);
            if (currentGuion && currentGuion.id === guionId) {
                currentGuion = null;
                currentGuionSecciones = [];
            }
            renderGuiones();
            renderSecciones();
            showAlert('Guion eliminado exitosamente', 'success');
        } else {
            const error = await response.json();
            showAlert('Error eliminando guion: ' + (error.detail || 'Error desconocido'), 'error');
        }
    } catch (error) {
        showAlert('Error eliminando guion: ' + error.message, 'error');
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}

