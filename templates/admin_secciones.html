{% extends "admin_base.html" %}

{% block title %}Gestión de Secciones{% endblock %}

{% block head_extra %}
<style>
    .two-column-layout {
        display: flex;
        height: calc(100vh - 150px);
        height: calc(100dvh - 150px);
        gap: 20px;
        margin-top: 20px;
        flex-direction: row;
    }
    
    .column {
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        overflow-y: auto;
        padding: 15px;
    }
    
    .column-left {
        flex: 0 0 35%;
        min-width: 0;
    }
    
    .column-right {
        flex: 1;
        min-width: 0;
    }
    
    /* Responsive para móvil */
    @media (max-width: 768px) {
        .two-column-layout {
            flex-direction: column;
            height: calc(100vh - 120px);
            height: calc(100dvh - 120px);
            gap: 15px;
            margin-top: 15px;
        }
        
        .column-left {
            flex: 0 0 auto;
            max-height: 40vh;
            max-height: 40dvh;
        }
        
        .column-right {
            flex: 1;
            min-height: 0;
        }
    }
    
    @media (max-width: 576px) {
        .column-left {
            max-height: 35vh;
            max-height: 35dvh;
            padding: 10px;
        }
        
        .column-right {
            padding: 10px;
        }
    }
    
    .column-header {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #337ab7;
        color: #337ab7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn-new {
        background-color: #5cb85c;
        color: white;
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-new:hover {
        background-color: #4cae4c;
    }
    
    .btn-save {
        background-color: #337ab7;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 15px;
        width: 100%;
    }
    
    .btn-save:hover {
        background-color: #286090;
    }
    
    .btn-delete {
        background-color: #d9534f;
        color: white;
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
    }
    
    .btn-delete:hover {
        background-color: #c9302c;
    }
    
    .seccion-item {
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .seccion-item:hover {
        background-color: #f5f5f5;
    }
    
    .seccion-item.active {
        background-color: #337ab7;
        color: white;
    }
    
    .seccion-item.active:hover {
        background-color: #286090;
    }
    
    .seccion-name {
        font-weight: bold;
    }
    
    .seccion-info {
        font-size: 11px;
        color: #666;
        margin-top: 3px;
    }
    
    .seccion-item.active .seccion-info {
        color: #e0e0e0;
    }
    
    .datos-container {
        margin-top: 15px;
    }
    
    .datos-tipo {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background-color: #fafafa;
    }
    
    .datos-tipo-header {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .datos-toggle {
        cursor: pointer;
        color: #337ab7;
        font-size: 12px;
    }
    
    .datos-list {
        display: none;
        margin-top: 10px;
    }
    
    .datos-list.expanded {
        display: block;
    }
    
    .dato-item {
        padding: 8px;
        margin-bottom: 5px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: white;
        display: flex;
        align-items: center;
    }
    
    .dato-checkbox {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .dato-info {
        flex: 1;
    }
    
    .dato-clave {
        font-weight: bold;
        font-size: 12px;
    }
    
    .dato-nombre {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="page-header">Gestión de Secciones</h1>

<div id="alert-container"></div>

<div class="two-column-layout">
    <!-- Columna Izquierda: Secciones -->
    <div class="column column-left">
        <div class="column-header">
            <span>Secciones</span>
            <button class="btn-new" onclick="createNewSeccion()">+ Nueva Sección</button>
        </div>
        <div id="secciones-list">
            <div class="empty-state">Cargando secciones...</div>
        </div>
    </div>
    
    <!-- Columna Derecha: Datos Disponibles -->
    <div class="column column-right">
        <div class="column-header">
            <span>Datos Disponibles</span>
        </div>
        <div id="datos-container">
            <div class="empty-state">Selecciona una sección para ver sus datos</div>
        </div>
    </div>
</div>

<!-- Modal para crear nueva sección -->
<div id="new-seccion-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; border-radius: 4px; width: 400px; max-width: 90%;">
        <h3>Crear Nueva Sección</h3>
        <div class="form-group">
            <label>Nombre del Archivo:</label>
            <input type="text" id="new-seccion-archivo" placeholder="Ej: 01_GENERALES_01" />
        </div>
        <div class="form-group">
            <label>Empresa:</label>
            <select id="new-seccion-empresa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Selecciona una empresa</option>
            </select>
        </div>
        <div class="form-group">
            <label>Tipo:</label>
            <select id="new-seccion-tipo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="entrevista">Entrevista</option>
                <option value="texto_informativo">Texto Informativo</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-save" onclick="confirmCreateSeccion()" style="margin: 0; flex: 1;">Crear</button>
            <button class="btn-delete" onclick="cancelCreateSeccion()" style="margin: 0; flex: 1; background: #999;">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
let allSecciones = [];
let allDatos = {
    informativo: [],
    dato_plano: [],
    grupo: [],
    archivo: [],
    conductual: []
};
let currentSeccion = null;
let currentSeccionData = null;

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadSecciones();
    loadEmpresas();
    loadAllDatos();
});

async function loadSecciones() {
    try {
        const response = await fetch(apiUrl('admin/api/secciones-disponibles'));
        const data = await response.json();
        allSecciones = data.secciones || [];
        renderSecciones();
    } catch (error) {
        showAlert('Error cargando secciones: ' + error.message, 'error');
    }
}

async function loadAllDatos() {
    const tipos = ['informativo', 'dato_plano', 'grupo', 'archivo', 'conductual'];
    
    for (const tipo of tipos) {
        try {
            const response = await fetch(apiUrl(`admin/api/datos-disponibles/${tipo}`));
            const data = await response.json();
            allDatos[tipo] = data.datos || [];
        } catch (error) {
            console.error(`Error cargando datos de tipo ${tipo}:`, error);
        }
    }
}

async function loadEmpresas() {
    try {
        const response = await fetch(apiUrl('admin/api/empresas'));
        const data = await response.json();
        const empresasSelect = document.getElementById('new-seccion-empresa');
        if (empresasSelect && data.empresas) {
            data.empresas.forEach(empresa => {
                const option = document.createElement('option');
                option.value = empresa;
                option.textContent = empresa;
                empresasSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando empresas:', error);
    }
}

function renderSecciones() {
    const seccionesList = document.getElementById('secciones-list');
    if (allSecciones.length === 0) {
        seccionesList.innerHTML = '<div class="empty-state">No hay secciones disponibles</div>';
        return;
    }
    
    seccionesList.innerHTML = '';
    allSecciones.forEach(seccion => {
        const item = document.createElement('div');
        item.className = 'seccion-item';
        if (currentSeccion && currentSeccion.archivo === seccion.archivo) {
            item.classList.add('active');
        }
        item.innerHTML = `
            <div>
                <div class="seccion-name">${seccion.archivo}</div>
                <div class="seccion-info">
                    Tipo: ${seccion.tipo || 'N/A'} | 
                    ${seccion.empresa ? `Empresa: ${seccion.empresa}` : 'Sin empresa'} |
                    Datos: ${seccion.datos_count || 0}
                </div>
            </div>
            <button class="btn-delete" onclick="deleteSeccion('${seccion.archivo}', event)">Eliminar</button>
        `;
        item.onclick = (e) => {
            if (e.target.classList.contains('btn-delete')) return;
            selectSeccion(seccion);
        };
        seccionesList.appendChild(item);
    });
}

async function selectSeccion(seccion) {
    currentSeccion = seccion;
    
    // Cargar los datos completos de la sección
    try {
        const response = await fetch(apiUrl(`admin/api/secciones/${seccion.archivo}`));
        const data = await response.json();
        currentSeccionData = data.seccion;
        renderDatos();
    } catch (error) {
        showAlert('Error cargando datos de la sección: ' + error.message, 'error');
    }
    
    renderSecciones();
}

function renderDatos() {
    const datosContainer = document.getElementById('datos-container');
    
    if (!currentSeccion || !currentSeccionData) {
        datosContainer.innerHTML = '<div class="empty-state">Selecciona una sección para ver sus datos</div>';
        return;
    }
    
    // Obtener grupo_datos de la sección
    let grupoDatos = [];
    const seccionKey = Object.keys(currentSeccionData)[0];
    if (seccionKey) {
        const seccionContent = currentSeccionData[seccionKey];
        grupoDatos = seccionContent.grupo_datos || [];
    }
    
    // Crear un set de claves activas
    const activeClaves = new Set();
    grupoDatos.forEach(dato => {
        const clave = dato.clave || dato.id;
        if (clave) {
            activeClaves.add(clave);
        }
    });
    
    datosContainer.innerHTML = '';
    
    // Crear contenedores para cada tipo de dato
    const tipos = [
        { key: 'informativo', label: 'Informativo' },
        { key: 'dato_plano', label: 'Datos Planos' },
        { key: 'grupo', label: 'Grupos' },
        { key: 'archivo', label: 'Archivos' },
        { key: 'conductual', label: 'Conductuales' }
    ];
    
    tipos.forEach(tipo => {
        const datosTipo = allDatos[tipo.key] || [];
        if (datosTipo.length === 0) return;
        
        const tipoDiv = document.createElement('div');
        tipoDiv.className = 'datos-tipo';
        tipoDiv.innerHTML = `
            <div class="datos-tipo-header">
                <span>${tipo.label} (${datosTipo.length})</span>
                <span class="datos-toggle" onclick="toggleDatosTipo('${tipo.key}')">▼ Expandir</span>
            </div>
            <div class="datos-list" id="datos-list-${tipo.key}">
                ${renderDatosList(datosTipo, activeClaves, tipo.key)}
            </div>
        `;
        datosContainer.appendChild(tipoDiv);
    });
    
    // Botón para guardar cambios
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.textContent = 'Guardar Cambios';
    saveBtn.onclick = saveSeccion;
    datosContainer.appendChild(saveBtn);
}

function renderDatosList(datos, activeClaves, tipo) {
    return datos.map(dato => {
        const isChecked = activeClaves.has(dato.clave);
        return `
            <div class="dato-item">
                <input type="checkbox" class="dato-checkbox" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleDato('${dato.clave}', '${tipo}', this.checked)"
                       data-clave="${dato.clave}"
                       data-tipo="${tipo}">
                <div class="dato-info">
                    <div class="dato-clave">${dato.clave}</div>
                    <div class="dato-nombre">${dato.nombre || 'Sin nombre'}</div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleDatosTipo(tipo) {
    const listDiv = document.getElementById(`datos-list-${tipo}`);
    const toggle = listDiv.previousElementSibling.querySelector('.datos-toggle');
    
    if (listDiv.classList.contains('expanded')) {
        listDiv.classList.remove('expanded');
        toggle.textContent = '▼ Expandir';
    } else {
        listDiv.classList.add('expanded');
        toggle.textContent = '▲ Colapsar';
    }
}

function toggleDato(clave, tipo, isChecked) {
    if (!currentSeccionData) return;
    
    // Obtener grupo_datos
    const seccionKey = Object.keys(currentSeccionData)[0];
    if (!seccionKey) return;
    
    let seccionContent = currentSeccionData[seccionKey];
    if (!seccionContent.grupo_datos) {
        seccionContent.grupo_datos = [];
    }
    
    if (isChecked) {
        // Agregar dato si no existe
        const exists = seccionContent.grupo_datos.some(d => (d.clave || d.id) === clave);
        if (!exists) {
            // Buscar el dato completo para obtener información adicional
            const datoCompleto = allDatos[tipo].find(d => d.clave === clave);
            
            const nuevoDato = {
                clave: clave,
                id: seccionContent.grupo_datos.length + 1,
                nombre: datoCompleto?.nombre || clave
            };
            
            seccionContent.grupo_datos.push(nuevoDato);
        }
    } else {
        // Remover dato
        seccionContent.grupo_datos = seccionContent.grupo_datos.filter(
            d => (d.clave || d.id) !== clave
        );
    }
}

function createNewSeccion() {
    document.getElementById('new-seccion-modal').style.display = 'flex';
    document.getElementById('new-seccion-archivo').value = '';
    document.getElementById('new-seccion-empresa').value = '';
    document.getElementById('new-seccion-tipo').value = 'entrevista';
}

function cancelCreateSeccion() {
    document.getElementById('new-seccion-modal').style.display = 'none';
}

async function confirmCreateSeccion() {
    const archivo = document.getElementById('new-seccion-archivo').value.trim();
    const empresa = document.getElementById('new-seccion-empresa').value;
    const tipo = document.getElementById('new-seccion-tipo').value;
    
    if (!archivo) {
        showAlert('Por favor ingresa un nombre para la sección', 'error');
        return;
    }
    
    if (!empresa) {
        showAlert('Por favor selecciona una empresa', 'error');
        return;
    }
    
    // Verificar que la sección no exista ya
    const archivoCompleto = archivo.endsWith('.json') ? archivo : `${archivo}.json`;
    const exists = allSecciones.some(s => s.archivo_completo === archivoCompleto && s.empresa === empresa);
    if (exists) {
        showAlert('Ya existe una sección con ese nombre en esa empresa', 'error');
        return;
    }
    
    // Crear estructura de sección vacía
    const nombreSeccion = archivo.replace('.json', '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const nuevaSeccionData = {
        [nombreSeccion]: {
            grupo_datos: [],
            idiomas_disponibles: ["ESP", "ENG"]
        }
    };
    
    // Si es texto informativo, agregar estructura específica
    if (tipo === 'texto_informativo') {
        nuevaSeccionData[nombreSeccion].tipo = 'texto_informativo';
    }
    
    // Guardar la sección
    try {
        const response = await fetch(apiUrl(`admin/api/secciones/${archivo}`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                seccion: nuevaSeccionData,
                empresa: empresa
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Recargar secciones
            await loadSecciones();
            cancelCreateSeccion();
            showAlert('Sección creada exitosamente', 'success');
        } else {
            const errorMsg = result.detail || result.message || 'Error desconocido';
            showAlert('Error creando sección: ' + errorMsg, 'error');
        }
    } catch (error) {
        showAlert('Error creando sección: ' + error.message, 'error');
    }
}

async function saveSeccion() {
    if (!currentSeccion || !currentSeccionData) {
        showAlert('No hay sección seleccionada', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/secciones/${currentSeccion.archivo}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                seccion: currentSeccionData,
                empresa: currentSeccion.empresa
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            // Recargar secciones para actualizar contadores
            await loadSecciones();
        } else {
            showAlert('Error: ' + (result.message || 'Error desconocido'), 'error');
        }
    } catch (error) {
        showAlert('Error guardando sección: ' + error.message, 'error');
    }
}

async function deleteSeccion(archivo, event) {
    event.stopPropagation();
    
    if (!confirm('¿Estás seguro de que deseas eliminar esta sección?')) {
        return;
    }
    
    try {
        const response = await fetch(apiUrl(`admin/api/secciones/${archivo}`), {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            allSecciones = allSecciones.filter(s => s.archivo !== archivo);
            if (currentSeccion && currentSeccion.archivo === archivo) {
                currentSeccion = null;
                currentSeccionData = null;
            }
            renderSecciones();
            renderDatos();
            showAlert('Sección eliminada exitosamente', 'success');
        } else {
            const errorMsg = result.detail || result.message || 'Error desconocido';
            showAlert('Error eliminando sección: ' + errorMsg, 'error');
        }
    } catch (error) {
        showAlert('Error eliminando sección: ' + error.message, 'error');
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}







